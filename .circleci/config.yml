version: 2
jobs:
    buildDev:
        environment:
            IMAGE_NAME: masterminddesign/masterminddesign-api
        docker:
            - image: circleci/buildpack-deps:stretch
        steps:
            - checkout
            - setup_remote_docker
            - run:
                name: Build Docker image
                command: docker build -t $IMAGE_NAME:dev .
            - run:
                name: Archive Docker image
                command: docker save -o image.tar $IMAGE_NAME
            - persist_to_workspace:
                root: .
                paths:
                - ./image.tar
    build:
        environment:
            IMAGE_NAME: masterminddesign/masterminddesign-api
        docker:
            - image: circleci/buildpack-deps:stretch
        steps:
            - checkout
            - setup_remote_docker
            - run:
                name: Build Docker image
                command: docker build -t $IMAGE_NAME:latest .
            - run:
                name: Archive Docker image
                command: docker save -o image.tar $IMAGE_NAME
            - persist_to_workspace:
                root: .
                paths:
                - ./image.tar
    publish-dev:
        executor: docker-publisher
        steps:
            - attach_workspace:
                at: /tmp/workspace
            - setup_remote_docker
            - run:
                name: Load archived Docker image
                command: docker load -i /tmp/workspace/image.tar
            - run:
                name: Publish Docker Image to Docker Hub
                command: |
                    docker login -u "$USERNAME" -p "$TOKEN" docker.pkg.github.com
                    docker push $IMAGE_NAME:dev
    publish-latest:
        executor: docker-publisher
        steps:
            - attach_workspace:
                at: /tmp/workspace
            - setup_remote_docker
            - run:
                name: Load archived Docker image
                command: docker load -i /tmp/workspace/image.tar
            - run:
                name: Publish Docker Image to Docker Hub
                command: |
                docker login -u "$USERNAME" -p "$TOKEN" docker.pkg.github.com
                docker push $IMAGE_NAME:latest
workflows:
    build-master:
        jobs:
            - build:
                filters:
                branches:
                    only: master
            - publish-latest:
                requires:
                - build
                filters:
                branches:
                    only: master
    build-develop:
        jobs:
            - build:
                filters:
                    branches:
                    only: develop
            - publish-latest:
                requires:
                    - build
                filters:
                    branches:
                    only: develop